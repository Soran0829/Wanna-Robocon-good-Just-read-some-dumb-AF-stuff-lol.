# Part 4: Gitのトラブルシューティング

Gitの操作でよく遭遇する問題と、その解決策をまとめました。エラーが発生しても慌てず、まずは `git status` で状況を確認する癖をつけましょう。

---

## 1. コミットに関する修正

### シナリオ1: 直前のコミットメッセージを修正したい
**状況:** `git commit` した直後、メッセージのタイポや内容の間違いに気づいた。

**解決策:**
```bash
git commit --amend
```
**解説:**
このコマンドを実行すると、エディタが開き、直前のコミットメッセージを編集できます。保存して閉じると、メッセージが修正された新しいコミットに置き換わります。

---
### シナリオ2: 直前のコミットにファイルを追加し忘れた
**状況:** コミットした後に、関連するファイルを `git add` し忘れていたことに気づいた。

**解決策:**
```bash
# 追加し忘れたファイルをステージング
git add <file-name>

# --no-editオプションでメッセージを再利用してコミットを修正
git commit --amend --no-edit
```
**解説:**
`--amend` は、ステージングエリアの内容を使って直前のコミットを再作成するコマンドです。ファイルを追加してから実行することで、コミットに含めることができます。`--no-edit` を付けると、メッセージの編集をスキップできます。

---
### シナリオ3: ローカルのコミットを取り消したい (まだpushしていない)
**状況:** いくつかコミットしたが、pushする前に作業をやり直したくなった。

**解決策:**
```bash
# 直前のコミットを取り消し、変更内容は残す（ステージングされた状態に戻る）
git reset --soft HEAD~1

# 直前のコミットを取り消し、変更内容は残す（ワーキングツリーに戻る）
git reset HEAD~1

# (危険!) 直前のコミットを取り消し、変更内容も完全に削除する
git reset --hard HEAD~1
```
**解説:**
- `git reset` は、ブランチの指すコミットを過去に移動させるコマンドです。
- `HEAD~1` は「1つ前のコミット」を指します。`~3`なら3つ前です。
- `--soft`: コミットだけを取り消します。変更はステージングエリアに残ります。
- `--mixed` (デフォルト): コミットとステージングを取り消します。変更はワーキングツリーに残ります。
- `--hard`: **最も危険なオプション。** コミット、ステージング、ワーキングツリーの変更がすべて消えます。元に戻せないので注意してください。

---
### シナリオ4: push済みのコミットを打ち消したい
**状況:** `main` ブランチなどにマージされ、すでにpush済みのコミットに間違いが見つかった。

**解決策:**
```bash
# 取り消したいコミットのハッシュ値を指定
git revert <commit-hash>
```
**解説:**
`git revert` は、指定したコミットが行った変更を「打ち消す」新しいコミットを作成します。共有された履歴を改変する `reset` とは異なり、履歴を安全に修正する方法です。`git log` で取り消したいコミットのハッシュ値（例: `a1b2c3d4`）を確認して使います。

---

## 2. ファイルやブランチの復元

### シナリオ5: ファイルの変更を取り消したい
**状況:** ファイルを編集したが、最新のコミットの状態に戻したくなった。

**解決策:**
```bash
# 特定のファイルの変更を、最新のコミットの状態に戻す
git restore <file-name>
```
**解説:**
ワーキングツリーでの変更を破棄します。ステージングしてしまった変更を元に戻す場合は `git restore --staged <file-name>` を使います。

---
### シナリオ6: 誤って削除したブランチを復元したい
**状況:** `git branch -d` で、まだ必要なブランチを間違って消してしまった。

**解決策:**
```bash
# 1. reflogで過去の操作履歴を確認
git reflog

# 2. 復元したいブランチの最後のコミットハッシュを見つける
# 例: a1b2c3d4 HEAD@{5}: checkout: moving from my-feature-branch to main

# 3. そのコミットから新しいブランチを作成
git branch <branch-name> a1b2c3d4
```
**解説:**
`git reflog` は、ブランチの移動やコミットなど、HEADが動いたすべての履歴を記録しています。これにより、削除したブランチが指していたコミットを見つけ出し、そこからブランチを復元できます。`reflog`はGitの「命綱」です。

---

## 3. リモートリポジトリとの連携

### シナリオ7: push/pull時にコンフリクトが発生した
**状況:** `git pull` や `git push` をしようとしたら、コンフリクト（競合）エラーが発生した。

**解決策:**
1.  **コンフリクトしたファイルを開く:**
    ファイル内に `<<<<<<< HEAD`, `=======`, `>>>>>>>` というマーカーで競合箇所が示されています。
2.  **手動で修正:**
    どちらの変更を残すか、あるいは両方を組み合わせるかを判断し、マーカーを削除してファイルを正しい状態に編集します。
3.  **修正したファイルをコミット:**
    ```bash
    git add <conflict-file-name>
    git commit -m "Fix merge conflict"
    ```
    `pull` 中のコンフリクトであれば `git commit` だけで完了です。

**解説:**
コンフリクトは、同じファイルの同じ箇所を複数の人が同時に変更した場合に発生します。Gitは自動でマージできないため、開発者に手動での解決を求めてきます。慌てず、どの変更が正しいかを確認して修正しましょう。
